# 03_user_model_and_jwt.md

## 작업 내용

- 사용자 모델(User)을 생성하고, 회원가입 및 로그인 기능을 구현한다.
- 로그인 시 JWT(JSON Web Token)를 발급하는 기능을 추가한다.

## 변경 사항

- `package.json`: `bcrypt`, `jsonwebtoken` 라이브러리를 추가한다.
- `models/User.js`: 사용자 정보를 저장하기 위한 Mongoose 스키마를 정의한다. 비밀번호는 `bcrypt`를 사용하여 암호화하여 저장하며, 비밀번호 비교를 위한 `comparePassword` 메서드를 추가한다.
- `backend/server.js`: `/api/register` (회원가입) 및 `/api/login` (로그인) API 엔드포인트를 추가한다. 로그인 성공 시 `jsonwebtoken`을 사용하여 JWT 토큰을 생성하고 사용자에게 반환한다.
- `.env`: JWT 토큰 서명에 사용될 `JWT_SECRET` 환경 변수를 추가한다.

## 관련 이론

### bcrypt

- `bcrypt`는 비밀번호 해싱을 위한 라이브러리이다. 
- **단방향 암호화** 방식을 사용하여, 원본 비밀번호를 암호화된 해시 값으로 변환하지만, 해시 값에서 원본 비밀번호를 알아내는 것은 거의 불가능하다.
- **솔트(Salt)** 를 사용하여 동일한 비밀번호라도 매번 다른 해시 값을 생성하여 레인보우 테이블 공격을 방지한다.

### JSON Web Token (JWT)

- JWT는 사용자 인증 및 정보 교환을 위한 간결하고 독립적인 방법을 제공하는 개방형 표준(RFC 7519)이다.
- JWT는 **Header**, **Payload**, **Signature** 세 부분으로 구성되며, 각 부분은 `.`으로 구분된다.
  - **Header**: 토큰의 유형(JWT)과 사용된 해싱 알고리즘(예: HMAC SHA256 또는 RSA)을 지정한다.
  - **Payload**: 클레임(claims)을 포함한다. 클레임은 사용자에 대한 정보나 토큰에 대한 추가 데이터를 나타낸다. (예: 사용자 ID, 만료 시간 등)
  - **Signature**: Header와 Payload를 인코딩한 값과 비밀 키를 사용하여 생성된다. 서명은 토큰의 무결성을 보장하는 데 사용된다. 즉, 토큰이 중간에 변경되지 않았음을 확인할 수 있다.
- JWT는 서버가 사용자의 로그인 상태를 기억할 필요가 없는 **무상태(stateless)** 인증을 가능하게 한다. 클라이언트는 로그인 후 받은 JWT를 모든 후속 요청에 포함하여 보내고, 서버는 이 토큰의 유효성을 검사하여 사용자를 인증한다.

## 파일 간 동작 설명

이 프로젝트에서 `user.js`, `server.js`, `test-api.js` 파일은 사용자 인증 흐름을 구현하고 테스트하는 데 긴밀하게 협력한다.

- **`models/User.js`**: 이 파일은 MongoDB에 저장될 사용자 데이터의 구조와 동작을 정의하는 Mongoose 스키마를 포함한다.
  - `userSchema.pre('save')`: 사용자가 회원가입하거나 비밀번호를 변경할 때, 데이터베이스에 저장되기 전에 이 훅이 실행되어 `bcrypt`를 사용하여 비밀번호를 안전하게 해싱한다.
  - `userSchema.methods.comparePassword`: 로그인 시 사용자가 입력한 비밀번호(평문)와 데이터베이스에 저장된 해시된 비밀번호를 비교하는 메서드를 제공한다. 이 메서드도 `bcrypt`를 사용하여 안전하게 비교한다.

- **`backend/server.js`**: 이 파일은 Express.js 서버를 설정하고, 사용자 인증을 위한 API 엔드포인트를 정의한다.
  - **회원가입 (`/api/register`)**: 클라이언트로부터 `username`, `email`, `password`를 받아 새로운 `User` 인스턴스를 생성한다. `user.save()`를 호출하면 `User.js`에 정의된 `pre('save')` 훅이 자동으로 트리거되어 비밀번호가 해싱된 후 데이터베이스에 저장된다.
  - **로그인 (`/api/login`)**: 클라이언트로부터 `email`과 `password`를 받아 데이터베이스에서 해당 이메일을 가진 사용자를 찾는다. 사용자를 찾으면, `User.js`에 정의된 `user.comparePassword(password)` 메서드를 호출하여 입력된 비밀번호와 저장된 비밀번호를 비교한다. 비밀번호가 일치하면 `jsonwebtoken` 라이브러리를 사용하여 사용자 ID를 포함하는 JWT를 생성하고, 이 토큰을 클라이언트에게 응답으로 보낸다.

- **`test-api.js`**: 이 파일은 `server.js`에 정의된 API 엔드포인트의 기능을 테스트하기 위한 스크립트이다.
  - **회원가입 테스트**: `server.js`의 `/api/register` 엔드포인트로 테스트 사용자 정보를 POST 요청으로 보낸다. 서버의 응답(성공 또는 실패)을 확인하여 회원가입 기능이 올바르게 작동하는지 검증한다.
  - **로그인 테스트**: 회원가입된 테스트 사용자의 이메일과 비밀번호를 사용하여 `server.js`의 `/api/login` 엔드포인트로 POST 요청을 보낸다. 서버로부터 JWT가 성공적으로 발급되는지 확인하여 로그인 기능이 올바르게 작동하는지 검증한다. 이 과정에서 `server.js`는 `User.js`의 `comparePassword` 메서드를 사용하여 비밀번호를 검증한다.

이러한 방식으로 세 파일은 유기적으로 연결되어 사용자 등록 및 인증이라는 핵심 기능을 제공한다.